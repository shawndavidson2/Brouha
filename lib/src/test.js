//import { Client } from 'node-appwrite';
import { updateUserAttributes, updateLeagueAttributes, getLeagueById } from './db.js';

const getRankCategory = (totalPoints) => {
    if (totalPoints >= 75000) return 'Legend';
    if (totalPoints >= 60000) return 'HOF';
    if (totalPoints >= 40000) return 'All-Pro';
    if (totalPoints >= 30000) return 'Pro';
    if (totalPoints >= 20000) return 'Varsity';
    if (totalPoints >= 10000) return 'JV';
    return 'Freshman';
};

const req = { "bodyRaw": "{\"pick-title\":\"KC -3\",\"potential-points\":926,\"status\":\"won\",\"game\":\"KC vs BAL\",\"time\":\" 8:20\\u202fPM\",\"date\":\"9\\/5\\/2024\",\"week\":3,\"$id\":\"66b0e32c00055c4316a2\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-08-05T14:35:25.063+00:00\",\"$updatedAt\":\"2024-08-05T15:08:24.444+00:00\",\"$permissions\":[\"read(\\\"user:669f0ccf0019b2358f11\\\")\",\"update(\\\"user:669f0ccf0019b2358f11\\\")\",\"delete(\\\"user:669f0ccf0019b2358f11\\\")\"],\"users\":[{\"username\":\"test11\",\"email\":\"test11@test.com\",\"avatar\":\"https:\\/\\/cloud.appwrite.io\\/v1\\/avatars\\/initials?name=test11&project=667edab40004ed4257b4\",\"accountId\":\"669f0ccf0019b2358f11\",\"rankCategory\":\"Freshman\",\"totalPoints\":0,\"leagueRank\":9999,\"totalRank\":9999,\"weekPoints\":0,\"$id\":\"669f0cd30017bcbd4723\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-23T01:52:19.910+00:00\",\"$updatedAt\":\"2024-08-05T14:30:41.504+00:00\",\"$permissions\":[\"read(\\\"user:669f0ccf0019b2358f11\\\")\",\"update(\\\"user:669f0ccf0019b2358f11\\\")\",\"delete(\\\"user:669f0ccf0019b2358f11\\\")\"],\"league\":{\"name\":\"Rivals\",\"rank\":8,\"weekly-total-points\":0,\"cumulative-total-points\":0,\"$id\":\"669f0f690004336919cb\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-23T02:03:21.459+00:00\",\"$updatedAt\":\"2024-08-05T15:04:24.926+00:00\",\"$permissions\":[\"read(\\\"user:669f0ccf0019b2358f11\\\")\",\"update(\\\"user:669f0ccf0019b2358f11\\\")\",\"delete(\\\"user:669f0ccf0019b2358f11\\\")\"],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"667f063b0031bb581c29\"},\"weekly-lineup\":[{\"totalPotentialPoints\":3406,\"totalPointsEarned\":0,\"weekNumber\":3,\"$id\":\"669f0fbd002630909b7a\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-23T02:04:46.037+00:00\",\"$updatedAt\":\"2024-08-05T14:55:12.272+00:00\",\"$permissions\":[\"read(\\\"user:669f0ccf0019b2358f11\\\")\",\"update(\\\"user:669f0ccf0019b2358f11\\\")\",\"delete(\\\"user:669f0ccf0019b2358f11\\\")\"],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"66849fe200344a0e6da9\"},{\"totalPotentialPoints\":714,\"totalPointsEarned\":0,\"weekNumber\":4,\"$id\":\"66ad35b70000ad624a1f\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-08-02T19:38:31.435+00:00\",\"$updatedAt\":\"2024-08-02T19:38:33.204+00:00\",\"$permissions\":[\"read(\\\"user:669f0ccf0019b2358f11\\\")\",\"update(\\\"user:669f0ccf0019b2358f11\\\")\",\"delete(\\\"user:669f0ccf0019b2358f11\\\")\"],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"66849fe200344a0e6da9\"}],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"667edc41000a189a99b7\"},{\"username\":\"test12\",\"email\":\"test12@test.com\",\"avatar\":\"https:\\/\\/cloud.appwrite.io\\/v1\\/avatars\\/initials?name=test12&project=667edab40004ed4257b4\",\"accountId\":\"669f15ce00173c427cbb\",\"rankCategory\":\"Freshman\",\"totalPoints\":0,\"leagueRank\":9999,\"totalRank\":9999,\"weekPoints\":0,\"$id\":\"669f15d0001843bb5d6e\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-23T02:30:40.828+00:00\",\"$updatedAt\":\"2024-08-05T15:04:23.298+00:00\",\"$permissions\":[\"read(\\\"user:669f15ce00173c427cbb\\\")\",\"update(\\\"user:669f15ce00173c427cbb\\\")\",\"delete(\\\"user:669f15ce00173c427cbb\\\")\"],\"league\":{\"name\":\"Rivals\",\"rank\":8,\"weekly-total-points\":0,\"cumulative-total-points\":0,\"$id\":\"669f0f690004336919cb\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-23T02:03:21.459+00:00\",\"$updatedAt\":\"2024-08-05T15:04:24.926+00:00\",\"$permissions\":[\"read(\\\"user:669f0ccf0019b2358f11\\\")\",\"update(\\\"user:669f0ccf0019b2358f11\\\")\",\"delete(\\\"user:669f0ccf0019b2358f11\\\")\"],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"667f063b0031bb581c29\"},\"weekly-lineup\":[{\"totalPotentialPoints\":3040,\"totalPointsEarned\":0,\"weekNumber\":3,\"$id\":\"669f16c9000dde2a7501\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-23T02:34:49.643+00:00\",\"$updatedAt\":\"2024-08-05T15:04:36.956+00:00\",\"$permissions\":[\"read(\\\"user:669f15ce00173c427cbb\\\")\",\"update(\\\"user:669f15ce00173c427cbb\\\")\",\"delete(\\\"user:669f15ce00173c427cbb\\\")\"],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"66849fe200344a0e6da9\"},{\"totalPotentialPoints\":1000,\"totalPointsEarned\":0,\"weekNumber\":4,\"$id\":\"66ad363800362485eeb0\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-08-02T19:40:41.371+00:00\",\"$updatedAt\":\"2024-08-02T19:40:52.650+00:00\",\"$permissions\":[\"read(\\\"user:669f15ce00173c427cbb\\\")\",\"update(\\\"user:669f15ce00173c427cbb\\\")\",\"delete(\\\"user:669f15ce00173c427cbb\\\")\"],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"66849fe200344a0e6da9\"}],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"667edc41000a189a99b7\"},{\"username\":\"test4\",\"email\":\"test4@test.com\",\"avatar\":\"https:\\/\\/cloud.appwrite.io\\/v1\\/avatars\\/initials?name=test4&project=667edab40004ed4257b4\",\"accountId\":\"668c3836001ca73f2808\",\"rankCategory\":\"Freshman\",\"totalPoints\":0,\"leagueRank\":9999,\"totalRank\":9999,\"weekPoints\":0,\"$id\":\"668c383a0026c250931e\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-08T19:04:27.154+00:00\",\"$updatedAt\":\"2024-08-05T02:32:45.383+00:00\",\"$permissions\":[\"read(\\\"user:668c3836001ca73f2808\\\")\",\"update(\\\"user:668c3836001ca73f2808\\\")\",\"delete(\\\"user:668c3836001ca73f2808\\\")\"],\"league\":{\"name\":\"my league\",\"rank\":1,\"weekly-total-points\":0,\"cumulative-total-points\":10,\"$id\":\"668563a400270a1cdb31\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-03T14:43:49.152+00:00\",\"$updatedAt\":\"2024-08-05T15:04:56.213+00:00\",\"$permissions\":[\"read(\\\"user:6685557d001f0f78f958\\\")\",\"update(\\\"user:6685557d001f0f78f958\\\")\",\"delete(\\\"user:6685557d001f0f78f958\\\")\"],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"667f063b0031bb581c29\"},\"weekly-lineup\":[{\"totalPotentialPoints\":3040,\"totalPointsEarned\":0,\"weekNumber\":3,\"$id\":\"669ac3350035704084c8\",\"$tenant\":\"159542\",\"$createdAt\":\"2024-07-19T19:49:10.396+00:00\",\"$updatedAt\":\"2024-08-05T15:05:36.390+00:00\",\"$permissions\":[\"read(\\\"user:668c3836001ca73f2808\\\")\",\"update(\\\"user:668c3836001ca73f2808\\\")\",\"delete(\\\"user:668c3836001ca73f2808\\\")\"],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"66849fe200344a0e6da9\"}],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"667edc41000a189a99b7\"}],\"$databaseId\":\"667edc260009e0dfc309\",\"$collectionId\":\"6684a04a000e85542756\"}", "body": { "pick-title": "KC -3", "potential-points": 926, "status": "won", "game": "KC vs BAL", "time": " 8:20â€¯PM", "date": "9/5/2024", "week": 3, "$id": "66b0e32c00055c4316a2", "$tenant": "159542", "$createdAt": "2024-08-05T14:35:25.063+00:00", "$updatedAt": "2024-08-05T15:08:24.444+00:00", "$permissions": ["read(\"user:669f0ccf0019b2358f11\")", "update(\"user:669f0ccf0019b2358f11\")", "delete(\"user:669f0ccf0019b2358f11\")"], "users": [{ "username": "test11", "email": "test11@test.com", "avatar": "https://cloud.appwrite.io/v1/avatars/initials?name=test11&project=667edab40004ed4257b4", "accountId": "669f0ccf0019b2358f11", "rankCategory": "Freshman", "totalPoints": 0, "leagueRank": 9999, "totalRank": 9999, "weekPoints": 0, "$id": "669f0cd30017bcbd4723", "$tenant": "159542", "$createdAt": "2024-07-23T01:52:19.910+00:00", "$updatedAt": "2024-08-05T14:30:41.504+00:00", "$permissions": ["read(\"user:669f0ccf0019b2358f11\")", "update(\"user:669f0ccf0019b2358f11\")", "delete(\"user:669f0ccf0019b2358f11\")"], "league": { "name": "Rivals", "rank": 8, "weekly-total-points": 0, "cumulative-total-points": 0, "$id": "669f0f690004336919cb", "$tenant": "159542", "$createdAt": "2024-07-23T02:03:21.459+00:00", "$updatedAt": "2024-08-05T15:04:24.926+00:00", "$permissions": ["read(\"user:669f0ccf0019b2358f11\")", "update(\"user:669f0ccf0019b2358f11\")", "delete(\"user:669f0ccf0019b2358f11\")"], "$databaseId": "667edc260009e0dfc309", "$collectionId": "667f063b0031bb581c29" }, "weekly-lineup": [{ "totalPotentialPoints": 3406, "totalPointsEarned": 0, "weekNumber": 3, "$id": "669f0fbd002630909b7a", "$tenant": "159542", "$createdAt": "2024-07-23T02:04:46.037+00:00", "$updatedAt": "2024-08-05T14:55:12.272+00:00", "$permissions": ["read(\"user:669f0ccf0019b2358f11\")", "update(\"user:669f0ccf0019b2358f11\")", "delete(\"user:669f0ccf0019b2358f11\")"], "$databaseId": "667edc260009e0dfc309", "$collectionId": "66849fe200344a0e6da9" }, { "totalPotentialPoints": 714, "totalPointsEarned": 0, "weekNumber": 4, "$id": "66ad35b70000ad624a1f", "$tenant": "159542", "$createdAt": "2024-08-02T19:38:31.435+00:00", "$updatedAt": "2024-08-02T19:38:33.204+00:00", "$permissions": ["read(\"user:669f0ccf0019b2358f11\")", "update(\"user:669f0ccf0019b2358f11\")", "delete(\"user:669f0ccf0019b2358f11\")"], "$databaseId": "667edc260009e0dfc309", "$collectionId": "66849fe200344a0e6da9" }], "$databaseId": "667edc260009e0dfc309", "$collectionId": "667edc41000a189a99b7" }, { "username": "test12", "email": "test12@test.com", "avatar": "https://cloud.appwrite.io/v1/avatars/initials?name=test12&project=667edab40004ed4257b4", "accountId": "669f15ce00173c427cbb", "rankCategory": "Freshman", "totalPoints": 0, "leagueRank": 9999, "totalRank": 9999, "weekPoints": 0, "$id": "669f15d0001843bb5d6e", "$tenant": "159542", "$createdAt": "2024-07-23T02:30:40.828+00:00", "$updatedAt": "2024-08-05T15:04:23.298+00:00", "$permissions": ["read(\"user:669f15ce00173c427cbb\")", "update(\"user:669f15ce00173c427cbb\")", "delete(\"user:669f15ce00173c427cbb\")"], "league": { "name": "Rivals", "rank": 8, "weekly-total-points": 0, "cumulative-total-points": 0, "$id": "669f0f690004336919cb", "$tenant": "159542", "$createdAt": "2024-07-23T02:03:21.459+00:00", "$updatedAt": "2024-08-05T15:04:24.926+00:00", "$permissions": ["read(\"user:669f0ccf0019b2358f11\")", "update(\"user:669f0ccf0019b2358f11\")", "delete(\"user:669f0ccf0019b2358f11\")"], "$databaseId": "667edc260009e0dfc309", "$collectionId": "667f063b0031bb581c29" }, "weekly-lineup": [{ "totalPotentialPoints": 3040, "totalPointsEarned": 0, "weekNumber": 3, "$id": "669f16c9000dde2a7501", "$tenant": "159542", "$createdAt": "2024-07-23T02:34:49.643+00:00", "$updatedAt": "2024-08-05T15:04:36.956+00:00", "$permissions": ["read(\"user:669f15ce00173c427cbb\")", "update(\"user:669f15ce00173c427cbb\")", "delete(\"user:669f15ce00173c427cbb\")"], "$databaseId": "667edc260009e0dfc309", "$collectionId": "66849fe200344a0e6da9" }, { "totalPotentialPoints": 1000, "totalPointsEarned": 0, "weekNumber": 4, "$id": "66ad363800362485eeb0", "$tenant": "159542", "$createdAt": "2024-08-02T19:40:41.371+00:00", "$updatedAt": "2024-08-02T19:40:52.650+00:00", "$permissions": ["read(\"user:669f15ce00173c427cbb\")", "update(\"user:669f15ce00173c427cbb\")", "delete(\"user:669f15ce00173c427cbb\")"], "$databaseId": "667edc260009e0dfc309", "$collectionId": "66849fe200344a0e6da9" }], "$databaseId": "667edc260009e0dfc309", "$collectionId": "667edc41000a189a99b7" }, { "username": "test4", "email": "test4@test.com", "avatar": "https://cloud.appwrite.io/v1/avatars/initials?name=test4&project=667edab40004ed4257b4", "accountId": "668c3836001ca73f2808", "rankCategory": "Freshman", "totalPoints": 0, "leagueRank": 9999, "totalRank": 9999, "weekPoints": 0, "$id": "668c383a0026c250931e", "$tenant": "159542", "$createdAt": "2024-07-08T19:04:27.154+00:00", "$updatedAt": "2024-08-05T02:32:45.383+00:00", "$permissions": ["read(\"user:668c3836001ca73f2808\")", "update(\"user:668c3836001ca73f2808\")", "delete(\"user:668c3836001ca73f2808\")"], "league": { "name": "my league", "rank": 1, "weekly-total-points": 0, "cumulative-total-points": 10, "$id": "668563a400270a1cdb31", "$tenant": "159542", "$createdAt": "2024-07-03T14:43:49.152+00:00", "$updatedAt": "2024-08-05T15:04:56.213+00:00", "$permissions": ["read(\"user:6685557d001f0f78f958\")", "update(\"user:6685557d001f0f78f958\")", "delete(\"user:6685557d001f0f78f958\")"], "$databaseId": "667edc260009e0dfc309", "$collectionId": "667f063b0031bb581c29" }, "weekly-lineup": [{ "totalPotentialPoints": 3040, "totalPointsEarned": 0, "weekNumber": 3, "$id": "669ac3350035704084c8", "$tenant": "159542", "$createdAt": "2024-07-19T19:49:10.396+00:00", "$updatedAt": "2024-08-05T15:05:36.390+00:00", "$permissions": ["read(\"user:668c3836001ca73f2808\")", "update(\"user:668c3836001ca73f2808\")", "delete(\"user:668c3836001ca73f2808\")"], "$databaseId": "667edc260009e0dfc309", "$collectionId": "66849fe200344a0e6da9" }], "$databaseId": "667edc260009e0dfc309", "$collectionId": "667edc41000a189a99b7" }], "$databaseId": "667edc260009e0dfc309", "$collectionId": "6684a04a000e85542756" }, "headers": { "host": "66b0ea004a684:3000", "user-agent": "Appwrite/1.5.8", "content-type": "application/json", "x-appwrite-trigger": "event", "x-appwrite-event": "databases.667edc260009e0dfc309.collections.6684a04a000e85542756.documents.66b0e32c00055c4316a2.update", "x-appwrite-user-id": "667cb51316bc45d0af32", "connection": "keep-alive", "content-length": "5816" }, "method": "POST", "host": "66b0ea004a684", "scheme": "http", "query": {}, "queryString": "", "port": 3000, "url": "http://66b0ea004a684:3000/", "path": "/" };
export const test = async () => {
    //   if (req.body["status"] === 'won') {
    req.body["users"].map((user) => {
        const points = req.body["potential-points"]

        //Need to update user: totalPoints, weekPoints, rankCategory,
        //Need to update league : "weekly-total-points", "cumulative-total-points"
        const userTotalPoints = user.totalPoints + points
        const userWeekPoints = user.weekPoints + points
        const rankCategory = getRankCategory(userTotalPoints)
        console.log("User " + user.username + ": " + userTotalPoints + " " + userWeekPoints + " " + rankCategory)
        const userAttributes = {
            totalPoints: userTotalPoints,
            weekPoints: userWeekPoints,
            rankCategory: rankCategory,
        };
        user.totalPoints = userTotalPoints;
        user.weekPoints = userWeekPoints;

        //await updateUserAttributes(user, userAttributes);
        getLeagueById(user.league.$id).then((res) => {
            const league = res;

            const leagueMembers = league.users.map(member =>
                member.username === user.username ? user : member);

            const sortedMembers = [...leagueMembers].sort((a, b) => b.weekPoints - a.weekPoints);
            const contributors = sortedMembers.slice(0, 5);
            sortedMembers.map((member) => { console.log(member.username) })
            console.log("contributors: " + contributors)
            if (contributors.includes(user)) {
                const leagueTotalPoints = league["cumulative-total-points"] + points
                const leagueWeekPoints = league["weekly-total-points"] + points
                console.log("League " + league.name + ": " + leagueTotalPoints + " " + leagueWeekPoints)
                const leagueAttributes = {
                    "weekly-total-points": leagueWeekPoints,
                    "cumulative-total-points": leagueTotalPoints,
                };

                league["weekly-total-points"] = leagueWeekPoints
                league["cumulative-total-points"] = leagueTotalPoints

                //updateLeagueAttributes(league, leagueAttributes);

            }
        })




    })
    //   }
    // `res.json()` is a handy helper for sending JSON
};

test();
